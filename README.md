# Book Cleaner + TTS Chunks

–ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫–Ω–∏–≥–∏ –∫ –æ–∑–≤—É—á–∫–µ –≤ **Yandex SpeechKit v3** –ø—Ä–∏ –ø–æ–º–æ—â–∏ **GPT‚Äë5 nano (OpenAI API)**: –æ—á–∏—Å—Ç–∫–∞ ¬´–≥—Ä—è–∑–Ω–æ–≥–æ¬ª TXT ‚Üí —Å–∫–ª–µ–π–∫–∞ ‚Üí –Ω–∞—Ä–µ–∑–∫–∞ –Ω–∞ 200‚Äë—Å–∏–º–≤–æ–ª—å–Ω—ã–µ –∫—É—Å–æ—á–∫–∏ ‚Üí –º–∞—Å—Å–æ–≤–∞—è –æ–∑–≤—É—á–∫–∞ –≤ MP3.

---

## üìÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –∫–Ω–∏–≥–∞ –≤ PDF, –º–æ–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –µ—ë –≤ —Ç–µ–∫—Å—Ç:

```bash
pdftotext book.pdf book.txt
```

–§–∞–π–ª `book.txt` –ø–æ–º–µ—Å—Ç–∏—Ç–µ –≤ –ø–∞–ø–∫—É `data/`.

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* Python 3.10+ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 3.12)
* macOS / Linux
* –ê–∫–∫–∞—É–Ω—Ç OpenAI (–∫–ª—é—á –¥–ª—è –º–æ–¥–µ–ª–∏ –æ—á–∏—Å—Ç–∫–∏) –∏ –∫–ª—é—á Yandex SpeechKit (API Key **–∏–ª–∏** IAM+Folder)

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

–í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```bash
cd ~/Downloads/speechKit_books/v2
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` (–ª–∏–±–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ `.env.example`) –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```env
# OpenAI (–æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞)
OPENAI_API_KEY=sk-–≤–∞—à-–∫–ª—é—á
BOOK_PATH=./data/book.txt
OUT_DIR=./out
OPENAI_MODEL=gpt-5-nano
MAX_CONTENT_TOKENS=9500

# Yandex SpeechKit (–ª—é–±–æ–π –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
# –í–∞—Ä–∏–∞–Ω—Ç A ‚Äî API-–∫–ª—é—á (–ø—Ä–æ—â–µ; FOLDER_ID –Ω–µ –Ω—É–∂–µ–Ω)
SPEECHKIT_API_KEY=yc-–≤–∞—à-api-key

# –í–∞—Ä–∏–∞–Ω—Ç B ‚Äî IAM-—Ç–æ–∫–µ–Ω + Folder ID
# IAM_TOKEN=...  
# FOLDER_ID=...  
```

> –í —Å–∫—Ä–∏–ø—Ç–µ TTS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ `.env` –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–µ—Ä–µ–∑ `python-dotenv`). –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫—Ä–µ–¥—ã —Ñ–ª–∞–≥–∞–º–∏ `--api-key` –∏–ª–∏ `--iam-token`/`--folder-id` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.

---

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
book-cleaner-tts/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ book.txt
‚îú‚îÄ‚îÄ out/
‚îÇ   ‚îú‚îÄ‚îÄ cleaned_full.txt
‚îÇ   ‚îî‚îÄ‚îÄ speechkit_chunks/
‚îÇ       ‚îú‚îÄ‚îÄ 00001.txt
‚îÇ       ‚îú‚îÄ‚îÄ 00002.txt
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ project_config/
‚îÇ   ‚îî‚îÄ‚îÄ settings.py
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ clean_and_chunk_book.py
    ‚îú‚îÄ‚îÄ prepare_jsonl.py
    ‚îî‚îÄ‚îÄ tts_speechkit_v3.py
```

> –ü–∞–ø–∫–∞ `config/` –±—ã–ª–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ `project_config/`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –≤–Ω–µ—à–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º `config` –∏–∑ PyPI. –°–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è **–∫–∞–∫ –º–æ–¥—É–ª–∏** (`python -m ...`), —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∑–æ–ª–≤–∏–ª–∏—Å—å –∏–º–ø–æ—Ä—Ç—ã.

---

## ‚ñ∂Ô∏è –®–∞–≥ 1. –û—á–∏—Å—Ç–∫–∞ –∫–Ω–∏–≥–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —á–∞–Ω–∫–æ–≤

–°–∫—Ä–∏–ø—Ç —á–∏—Ç–∞–µ—Ç `data/book.txt`, –¥–µ–ª–∏—Ç –Ω–∞ —á–∞–Ω–∫–∏ ‚â§ 9500 —Ç–æ–∫–µ–Ω–æ–≤ (–±–µ–∑ —Ä–∞–∑—Ä—ã–≤–∞ —Å–ª–æ–≤), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥—ã–π –≤ GPT‚Äë5 nano —Å –ø—Ä–æ–º–ø—Ç–æ–º‚Äë¬´—á–∏—Å—Ç–∏–ª—å—â–∏–∫–æ–º¬ª, —Å–∫–ª–µ–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –∏ —Ä–µ–∂–µ—Ç –Ω–∞ –∫—É—Å–æ—á–∫–∏ ‚â§ 200 —Å–∏–º–≤–æ–ª–æ–≤.

–ó–∞–ø—É—Å–∫:

```bash
python -m scripts.clean_and_chunk_book
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:

* `out/cleaned_full.txt` ‚Äî —Ü–µ–ª—å–Ω—ã–π –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
* `out/speechkit_chunks/00001.txt ‚Ä¶` ‚Äî –∫—É—Å–æ—á–∫–∏ –ø–æ ‚â§ 200 —Å–∏–º–≤–æ–ª–æ–≤.

> –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∏–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ `python -m ...`.

---

## üßæ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –®–∞–≥ 2. –°–æ–±—Ä–∞—Ç—å JSONL

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ JSONL –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤:

```bash
python -m scripts.prepare_jsonl
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: `out/speechkit_chunks.jsonl`

---

## üîä –®–∞–≥ 3. –û–∑–≤—É—á–∫–∞ —á–µ—Ä–µ–∑ SpeechKit v3 (REST)

–°–∫—Ä–∏–ø—Ç —Å—Ç—Ä–∏–º–∏—Ç –∞—É–¥–∏–æ‚Äë—á–∞–Ω–∫–∏ `audioChunk.data` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç MP3.

–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ (–≥–æ–ª–æ—Å **filipp**, —Å–∫–æ—Ä–æ—Å—Ç—å **1.1x**, MP3):

```bash
python -m scripts.tts_speechkit_v3 \
  --voice filipp \
  --speed 1.1 \
  --container MP3 \
  --sleep 0.2
```

–ü—É—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:

* –≤—Ö–æ–¥: `./out/speechkit_chunks/`
* –≤—ã—Ö–æ–¥: `./out/audio/00001.mp3`, `00002.mp3`, ‚Ä¶

### –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ–ª–∞–≥–∏

* `--in-dir ./out/speechkit_chunks` ‚Äî –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏.
* `--out-dir ./out/audio` ‚Äî –∫—É–¥–∞ –ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ.
* `--start 501` ‚Äî –Ω–∞—á–∞—Ç—å —Å —Ñ–∞–π–ª–∞ `00501.txt` (—É–¥–æ–±–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è).
* `--limit 100` ‚Äî —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å N —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–±—ã.
* `--api-key ...` ‚Äî –ø–µ—Ä–µ–¥–∞—Ç—å API‚Äë–∫–ª—é—á –ø—Ä—è–º–æ —Ñ–ª–∞–≥–æ–º (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `.env`).
* `--iam-token ... --folder-id ...` ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ IAM.

### –ü—Ä–∏–º–µ—Ä—ã

–û–∑–≤—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–µ 100 –∫—É—Å–æ—á–∫–æ–≤ –≤ MP3:

```bash
python -m scripts.tts_speechkit_v3 --limit 100
```

–î–æ–≥–Ω–∞—Ç—å—Å—è —Å 501‚Äë–≥–æ:

```bash
python -m scripts.tts_speechkit_v3 --start 501
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ WAV:

```bash
python -m scripts.tts_speechkit_v3 --container WAV
```

---

## üõ†Ô∏è Troubleshooting

* **`[FATAL] –ù—É–∂–µ–Ω SPEECHKIT_API_KEY –∏–ª–∏ IAM_TOKEN + FOLDER_ID`** ‚Äî —Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞—à—ë–ª –∫—Ä–µ–¥—ã. –†–µ—à–µ–Ω–∏—è:

  1. –ø–æ–ª–æ–∂–∏—Ç—å `SPEECHKIT_API_KEY` –≤ `.env`;
  2. –ø–µ—Ä–µ–¥–∞—Ç—å `--api-key` —Ñ–ª–∞–≥–æ–º;
  3. –¥–ª—è IAM ‚Äî `--iam-token` **–∏** `--folder-id`.
* **`Unknown role '...' for 'filipp' voice` (HTTP 400)** ‚Äî —É–∫–∞–∑–∞–Ω–Ω–∞—è —Ä–æ–ª—å –≥–æ–ª–æ—Å–æ–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –õ–∏–±–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ `--role` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–æ–ª—å –æ—Ç–∫–ª—é—á–µ–Ω–∞), –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ–ª–æ—Å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω—É–∂–Ω–æ–π —Ä–æ–ª–∏.
* **429/5xx** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/–æ—à–∏–±–∫–∏. –°–∫—Ä–∏–ø—Ç –¥–µ–ª–∞–µ—Ç —Ä–µ—Ç—Ä–∞–∏; –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö 429 —É–≤–µ–ª–∏—á—å—Ç–µ `--sleep` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `0.4`‚Äì`1.0`).
* **–ü—Ä–µ—Ä–≤–∞–ª—Å—è –ø—Ä–æ—Ü–µ—Å—Å** ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å `--start <N>` (–Ω–æ–º–µ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —Å–ø–∏—Å–∫—É).

---

## üìë –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 9500 —Ç–æ–∫–µ–Ω–æ–≤ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∞—Å –¥–æ –ª–∏–º–∏—Ç–∞ 10‚ÄØ000 —Å —É—á—ë—Ç–æ–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
* –ß–∞–Ω–∫–∏ –ø–æ 200 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–µ —Ä–≤—É—Ç —Å–ª–æ–≤–∞ (—Ä–µ–∑–∫–∞ –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π/—Å–ª–æ–≤).
* –î–ª—è `gpt-5-nano` –æ–ø—Ü–∏–∏ –≤—Ä–æ–¥–µ `temperature` –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∞–Ω—ã ‚Äî –º—ã –∏—Ö –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º.
* –ü–∞–ø–∫–∞ `out/audio` —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–æ—Ç–æ–≤—ã–µ MP3; –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Å–∫–ª–µ–π–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, `ffmpeg` –∏–ª–∏ `pydub` (–Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç).

---

## ‚úÖ –ö—Ä–∞—Ç–∫–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –∑–∞–ø—É—Å–∫—É

```bash
# 1) –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source .venv/bin/activate

# 2) –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–∞—Ä–µ–∑–∫–∞
python -m scripts.clean_and_chunk_book

# 3) –û–∑–≤—É—á–∫–∞ (filipp, 1.1x, MP3)
python -m scripts.tts_speechkit_v3 --voice filipp --speed 1.1 --container MP3
```

---

## üéº –°–∫–ª–µ–π–∫–∞ MP3 —Ñ–∞–π–ª–æ–≤

–ü–æ—Å–ª–µ –æ–∑–≤—É—á–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å–æ—Ç–Ω–∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö mp3. –ò—Ö —É–¥–æ–±–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª –ø—Ä–∏ –ø–æ–º–æ—â–∏ **ffmpeg**.

### –í–∞—Ä–∏–∞–Ω—Ç A ‚Äî –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (–±—ã—Å—Ç—Ä–æ)

–ï—Å–ª–∏ –≤—Å–µ mp3 –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ–±—ã—á–Ω–æ —Ç–∞–∫ —É SpeechKit):

```bash
# –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
cd out/audio

# —Å–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
ls -1 *.mp3 | sort | awk '{print "file \\"" $0 "\\""}' > list.txt

# —Å–∫–ª–µ–∏–≤–∞–µ–º –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
ffmpeg -f concat -safe 0 -i list.txt -c copy ../book_full.mp3
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```bash
ffprobe ../book_full.mp3 -hide_banner
```

### –í–∞—Ä–∏–∞–Ω—Ç B ‚Äî —Å –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–Ω–∞–¥—ë–∂–Ω–æ)

–ï—Å–ª–∏ `-c copy` –¥–∞—ë—Ç –æ—à–∏–±–∫—É:

```bash
ffmpeg -f concat -safe 0 -i list.txt -c:a libmp3lame -b:a 128k ../book_full.mp3
```

–ú–∏–Ω—É—Å: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—è (–Ω–µ–º–Ω–æ–≥–æ —Ö—É–∂–µ –∫–∞—á–µ—Å—Ç–≤–æ, –¥–æ–ª—å—à–µ), –ø–ª—é—Å: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.

---
